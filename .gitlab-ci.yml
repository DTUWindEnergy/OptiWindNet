image: continuumio/miniconda3

# ===== TEST OptiWindNet linux=====
#test_optiwindnet:
#  stage: 
#    test
#  script:
#  - pip install .[test]
#  - python -m pytest
#  tags:
#  - linux

# ===== TEST OptiWindNet windows=====
#test_optiwindnet_windows:
#  stage:
#    test
#  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
#  script:
#  - conda init powershell
#  - "if (test-path $PROFILE.CurrentUserAllHosts) { & $PROFILE.CurrentUserAllHosts}"
#  - conda activate optiwindnet_env
#  - pip install -e . --no-deps
#  - pytest --cov-report term-missing:skip-covered --cov=optiwindnet --cov-config .coveragerc
#  tags:
#  - ANMH_old
#
# ===== DEPLOY optiwindnet docs=====
pages:
  stage:  
    deploy
  script:  
  - apt-get update
  - apt-get -y install make pandoc graphviz
  - pip install --upgrade pip ipython ipykernel sphinx nbsphinx autoapi sphinx_rtd_theme sphinx-autoapi furo
  - ipython kernel install --name "python3" --user
  - pip install .[test,docs] --upgrade --no-deps
  - cd docs; make html
  - cd ../; mv docs/build/html public/
  artifacts:
    paths:
    - public
  only: 
  - /^test_docdeploy.*/ 
  - main
  tags: 
  - linux

# ===== DEPLOY publish optiwindnet on pypi=====
pypi_linux:
  stage:
    deploy
  only:
    - tags
    - test_pypi
  script:
    - apt-get update
    - pip install --upgrade pip
    - pip install -e . --upgrade
    - pip install --upgrade build
    - pip install --upgrade twine packaging
    - python3 -m build
    - twine upload dist/* -u $TWINE_USERNAME -p $TWINE_PASSWORD
  tags:
  - ci-ubuntu
